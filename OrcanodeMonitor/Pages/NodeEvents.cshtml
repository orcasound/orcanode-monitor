@page "{id}"
@model OrcanodeMonitor.Pages.NodeEventsModel
@{
    ViewData["Title"] = "Node Events";
}

<div class="text-center">
    <h1 class="display-4">@Model.NodeName</h1>

    <!-- Navigation Button -->
    <button onclick="location.href='@Url.Page("/SpectralDensity", new { id = Model.Id })'" class="btn btn-primary">
        View Most Recent Spectral Density
    </button>
    <p></p>

    <div>
        Uptime percentage: @Model.UptimePercentage%
        <p></p>
    </div>

    <!-- Filter Buttons for Time Range -->
    <div>
        Filter by Time Range:
        <button id="btn-timeRange-pastWeek" class="btn unselected" onclick="updateFilter('timeRange', 'pastWeek')">Past Week</button>
        <button id="btn-timeRange-allTime" class="btn selected" onclick="updateFilter('timeRange', 'allTime')">Past Month</button>
        <p></p>
    </div>

    <!-- Filter Buttons for Type -->
    <div>
        Filter by Type:
        <button id="btn-type-all" class="btn selected" onclick="updateFilter('type', 'all')">All</button>
        <button id="btn-type-hydrophoneStream" class="btn unselected" onclick="updateFilter('type', 'hydrophoneStream')">Hydrophone Stream</button>
        <button id="btn-type-dataplicityConnection" class="btn unselected" onclick="updateFilter('type', 'dataplicityConnection')">Dataplicity Connection</button>
        <button id="btn-type-mezmoLogging" class="btn unselected" onclick="updateFilter('type', 'mezmoLogging')">Mezmo Logging</button>
        <p></p>
    </div>

    <table id="eventsTable" class="table">
        <thead>
            <tr>
                <th>Timestamp (Pacific)</th>
                <th>Event</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.RecentEvents.Any())
            {
                <tr>
                    <td colspan="2" class="text-center">No events found for this time period.</td>
                </tr>
            }
            @foreach (Models.OrcanodeEvent item in Model.RecentEvents)
            {
                <tr class="@Model.GetEventClasses(item)">
                    <td>@item.DateTimeLocal.ToString("g")</td>
                    <td align="left">@item.Description</td>
                </tr>
            }
        </tbody>
    </table>

    <script>
        var currentFilters = {
            timeRange: 'allTime',
            type: 'all' };

        function updateFilter(filterType, filterValue) {
            // Update time range filter.
            if (filterType == 'timeRange') {
                var oldTimeRangeButtonId = 'btn-timeRange-' + currentFilters.timeRange;
                var oldTimeRangeButton = document.getElementById(oldTimeRangeButtonId);
                oldTimeRangeButton.classList.remove('selected');
                oldTimeRangeButton.classList.add('unselected');

                currentFilters.timeRange = filterValue;

                var newTimeRangeButtonId = 'btn-timeRange-' + currentFilters.timeRange;
                var newTimeRangeButton = document.getElementById(newTimeRangeButtonId);
                newTimeRangeButton.classList.remove('unselected');
                newTimeRangeButton.classList.add('selected');
            }
            
            // Update type filter.
            if (filterType == 'type') {
                var oldTypeButtonId = 'btn-type-' + currentFilters.type;
                var oldTypeButton = document.getElementById(oldTypeButtonId);
                oldTypeButton.classList.remove('selected');
                oldTypeButton.classList.add('unselected');

                currentFilters.type = filterValue;

                var newTypeButtonId = 'btn-type-' + currentFilters.type;
                var newTypeButton = document.getElementById(newTypeButtonId);
                newTypeButton.classList.remove('unselected');
                newTypeButton.classList.add('selected');
            }

            filterTable();
        }

        function filterTable() {
            // Get all rows from the table.
            var rows = document.querySelectorAll('#eventsTable tbody tr');
            
            // Loop through each row.
            rows.forEach(function(row) {
                // Check if the row matches the selected time range and type
                var matchesTimeRange = (currentFilters.timeRange === 'allTime' || row.classList.contains(currentFilters.timeRange));
                var matchesType = (currentFilters.type === 'all' || row.classList.contains(currentFilters.type));
                
                if (matchesTimeRange && matchesType) {
                    row.style.display = ''; // Show matching rows.
                } else {
                    row.style.display = 'none'; // Hide non-matching rows.
                }
            });
        }
    </script>
</div>
